<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–ø–∞—Å–∏–±–æ ‚Äî –¥–ª—è —Ç–µ–±—è</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --primary: #6c5ce7;
      --secondary: #a29bfe;
      --light: #f8f9fa;
      --dark: #2d3436;
      --success: #00b894;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: var(--transition);
    }

    .container {
      max-width: 600px;
      width: 100%;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: var(--shadow);
      text-align: center;
    }

    h1 {
      color: var(--primary);
      font-size: 2.5rem;
      margin-bottom: 10px;
      line-height: 1.2;
    }

    p.subtitle {
      color: var(--dark);
      font-size: 1.1rem;
      margin-bottom: 30px;
      opacity: 0.8;
    }

    .recorder {
      margin: 30px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 15px;
      position: relative;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      margin: 10px;
      min-width: 150px;
    }

    .btn-record {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3);
    }

    .btn-record:hover {
      background: #5649c0;
      transform: translateY(-2px);
    }

    .btn-play {
      background: var(--secondary);
      color: white;
    }

    .btn-send {
      background: var(--success);
      color: white;
    }

    .btn-send:hover {
      background: #00a17a;
    }

    .btn-reset {
      background: #ff7675;
      color: white;
    }

    .timer {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary);
      margin: 15px 0;
    }

    .email-input {
      width: 100%;
      padding: 12px;
      margin: 15px 0;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 1rem;
      transition: var(--transition);
    }

    .email-input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
    }

    .status {
      margin: 20px 0;
      padding: 10px;
      border-radius: 10px;
      font-weight: 500;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .hidden {
      display: none;
    }

    .heart-animation {
      font-size: 3rem;
      color: #e91e63;
      animation: pulse 1s ease-in-out infinite;
      margin: 20px auto;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .footer {
      margin-top: 30px;
      font-size: 0.9rem;
      color: #666;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      h1 {
        font-size: 2rem;
      }
      .btn {
        min-width: auto;
        width: 100%;
        margin: 10px 0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>–°–ø–∞—Å–∏–±–æ ‚ù§Ô∏è</h1>
    <p class="subtitle">–°–∫–∞–∂–∏ —Å–ø–∞—Å–∏–±–æ —Ç–æ–º—É, –∫—Ç–æ —Ç–µ–±–µ –¥–æ—Ä–æ–≥. –ü—Ä–æ—Å—Ç–æ —Ç–∞–∫. –ë–µ–∑ –ø–æ–≤–æ–¥–∞.</p>

    <div class="recorder">
      <div id="record-btn" class="btn btn-record">–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ</div>
      <div id="timer" class="timer hidden">00:00</div>
      <div id="play-btn" class="btn btn-play hidden">‚ñ∂ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</div>
      <div id="download-btn" class="btn btn-success hidden">‚¨á –°–∫–∞—á–∞—Ç—å</div>
    </div>

    <input type="email" id="email-input" class="email-input" placeholder="Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è" />

    <div id="send-btn" class="btn btn-send hidden">üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ email</div>
    <div id="reset-btn" class="btn btn-reset hidden">üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</div>

    <div id="status" class="status hidden"></div>

    <div id="thank-you" class="hidden">
      <div class="heart-animation">‚ù§Ô∏è</div>
      <h2>–°–ø–∞—Å–∏–±–æ –∑–∞ —Ç—ë–ø–ª—ã–µ —Å–ª–æ–≤–∞!</h2>
      <p>–¢—ã —Å–¥–µ–ª–∞–ª —á—å—é-—Ç–æ –∂–∏–∑–Ω—å –Ω–µ–º–Ω–æ–≥–æ —Å–≤–µ—Ç–ª–µ–µ.</p>
    </div>

    <div class="footer">
      <p>–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ç–≤–æ—ë–º –±—Ä–∞—É–∑–µ—Ä–µ. –ù–∏–∫—Ç–æ –Ω–µ –≤–∏–¥–∏—Ç —Ç–≤–æ–∏ –∑–∞–ø–∏—Å–∏.</p>
    </div>
  </div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const recordBtn = document.getElementById('record-btn');
    const playBtn = document.getElementById('play-btn');
    const downloadBtn = document.getElementById('download-btn');
    const sendBtn = document.getElementById('send-btn');
    const resetBtn = document.getElementById('reset-btn');
    const emailInput = document.getElementById('email-input');
    const timerEl = document.getElementById('timer');
    const statusEl = document.getElementById('status');
    const thankYouEl = document.getElementById('thank-you');

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let mediaRecorder;
    let chunks = [];
    let audioBlob;
    let isRecording = false;
    let startTime;
    let timerInterval;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞
    function updateTimer() {
      const now = Date.now();
      const elapsed = Math.floor((now - startTime) / 1000);
      const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
      const secs = (elapsed % 60).toString().padStart(2, '0');
      timerEl.textContent = `${mins}:${secs}`;
    }

    // –ó–∞–ø–∏—Å—å
    recordBtn.addEventListener('click', async () => {
      if (isRecording) {
        // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
        mediaRecorder.stop();
        recordBtn.textContent = '–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ';
        recordBtn.classList.remove('btn-record');
        recordBtn.classList.add('btn-success');
        isRecording = false;
        clearInterval(timerInterval);

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏
        playBtn.classList.remove('hidden');
        downloadBtn.classList.remove('hidden');
        sendBtn.classList.remove('hidden');
        resetBtn.classList.remove('hidden');
        timerEl.classList.add('hidden');

        // –°–æ–∑–¥–∞—Ç—å –∞—É–¥–∏–æ-–æ–±—ä–µ–∫—Ç
        audioBlob = new Blob(chunks, { type: 'audio/webm' });
        chunks = [];

        showStatus('–ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å.', 'success');
      } else {
        // –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);

          mediaRecorder.ondataavailable = e => chunks.push(e.data);
          mediaRecorder.onstop = () => {
            stream.getTracks().forEach(track => track.stop());
          };

          mediaRecorder.start();
          isRecording = true;
          startTime = Date.now();
          timerInterval = setInterval(updateTimer, 1000);

          recordBtn.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
          recordBtn.classList.remove('btn-success');
          recordBtn.classList.add('btn-record');
          timerEl.classList.remove('hidden');

          showStatus('–ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å... –ú–∞–∫—Å. 30 —Å–µ–∫—É–Ω–¥', 'info');
        } catch (err) {
          showStatus('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + err.message, 'error');
        }
      }
    });

    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
    playBtn.addEventListener('click', () => {
      if (!audioBlob) return;
      const audioUrl = URL.createObjectURL(audioBlob);
      const audio = new Audio(audioUrl);
      audio.play();
      showStatus('–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ...', 'info');
    });

    // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
    downloadBtn.addEventListener('click', () => {
      if (!audioBlob) return;
      const url = URL.createObjectURL(audioBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = '—Å–ø–∞—Å–∏–±–æ_' + new Date().toLocaleDateString() + '.webm';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      showStatus('–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ', 'success');
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ email
    sendBtn.addEventListener('click', () => {
      const email = emailInput.value.trim();
      if (!audioBlob) {
        showStatus('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—à–∏—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!', 'error');
        return;
      }

      if (!email) {
        showStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ email –ø–æ–ª—É—á–∞—Ç–µ–ª—è!', 'error');
        return;
      }

      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∞—É–¥–∏–æ –≤ base64
      const reader = new FileReader();
      reader.onload = function() {
        const base64Audio = reader.result.split(',')[1]; // –£–±–∏—Ä–∞–µ–º audio/webm;base64,
        const audioId = Date.now().toString(36) + Math.random().toString(36).substr(2);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ fetch
        fetch('/api/bot', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            type: 'send_voice_email',
            audioId: audioId,
            audioData: base64Audio,
            email: email
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showStatus('–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ü–æ–ª—É—á–∞—Ç–µ–ª—å —Å–∫–æ—Ä–æ —É—Å–ª—ã—à–∏—Ç –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.', 'success');
            setTimeout(() => {
              thankYouEl.classList.remove('hidden');
              document.querySelector('.container').classList.add('hidden');
            }, 1500);
          } else {
            showStatus('–û—à–∏–±–∫–∞: ' + data.error, 'error');
          }
        })
        .catch(err => {
          showStatus('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message, 'error');
        });
      };
      reader.readAsDataURL(audioBlob);
    });

    // –°–±—Ä–æ—Å
    resetBtn.addEventListener('click', () => {
      if (audioBlob) {
        URL.revokeObjectURL(URL.createObjectURL(audioBlob));
        audioBlob = null;
      }
      chunks = [];
      isRecording = false;
      clearInterval(timerInterval);
      timerEl.textContent = '00:00';
      timerEl.classList.add('hidden');
      playBtn.classList.add('hidden');
      downloadBtn.classList.add('hidden');
      sendBtn.classList.add('hidden');
      resetBtn.classList.add('hidden');
      recordBtn.textContent = '–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ';
      recordBtn.classList.remove('btn-success');
      recordBtn.classList.add('btn-record');
      emailInput.value = '';
      showStatus('–í—Å—ë —Å–±—Ä–æ—à–µ–Ω–æ. –ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å —Å–Ω–æ–≤–∞?', 'success');
      thankYouEl.classList.add('hidden');
      document.querySelector('.container').classList.remove('hidden');
    });

    // –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç—É—Å–∞
    function showStatus(text, type) {
      statusEl.textContent = text;
      statusEl.className = `status ${type}`;
      statusEl.classList.remove('hidden');
      setTimeout(() => {
        statusEl.classList.add('hidden');
      }, 3000);
    }
  </script>
</body>
</html>
